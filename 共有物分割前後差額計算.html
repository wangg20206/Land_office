<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>åˆ†å‰²å‰å¾ŒåœŸåœ°åœ°ç¨…è¨ˆç®—</title>
  <link rel="icon" href="å¤§æºªåœ°æ”¿.ico">
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; }
    .main-wrapper { padding:24px; max-width:80%; margin:0 auto; }
    h1 { text-align:center; }
    h2 { margin-top:32px; color:#333; }
    h3 { margin-top:32px; color:#e20505; }
    table { width:100%; border-collapse:collapse; margin-bottom:16px; background:#fff; }
    th,td { border:1px solid #ccc; padding:6px 8px; text-align:center; }
    th { background:#e0e0e0; }
    input[type="number"], input[type="text"] { width:90%; padding:4px; box-sizing:border-box; }
    .btn { padding:6px 12px; margin:4px; border:none; color:#fff; cursor:pointer; border-radius:4px; }
    .btn-add { background:#4caf50; }
    .btn-calc { background:#2196f3; }
    .btn-del { background:#f44336; }
    #calcTaxBtn { background:#ff9800; }
  </style>
</head>

<body>
  <div id="header-container"></div>

  <div class="main-wrapper">
    <h1>å…±æœ‰ç‰©åˆ†å‰²å‰å¾Œå·®é¡è¨ˆç®—</h1>
    <h3>è«‹ç¢ºèªè¼¸å…¥è³‡æ–™èˆ‡å…±æœ‰ç‰©åˆ†å‰²å”è­°æ›¸ç›¸ç¬¦</h3>
    <h3>æœ¬è¡¨è¨ˆç®—çµæœåƒ…ä¾›åƒè€ƒ</h3>
    <h3>å¦‚è¦ä½¿ç”¨åŒ¯å…¥æª”æ¡ˆï¼Œè«‹ä½¿ç”¨æœ¬ç¶²é æä¾›ä¹‹è¨ˆç®—æ ¼å¼(excel)</h3><br>

    <a href="./åˆ†å‰²å‰å¾ŒåœŸåœ°åˆ†å‰²ç¯„ä¾‹.xlsx" download class="btn btn-add">ğŸ“¥ ä¸‹è¼‰ Excel ç¯„ä¾‹</a>
    <input type="file" id="importExcel" accept=".xlsx,.xls" />

    <!-- åˆ†å‰²å‰ -->
    <h2>åˆ†å‰²å‰</h2>
    <table id="preTable">
      <thead>
        <tr>
          <th>é„‰é®å¸‚å€</th><th>æ®µ</th><th>å°æ®µ</th><th>åœ°è™Ÿ</th><th>é¢ç©</th>
          <th>æ‰€æœ‰æ¬Šäºº</th><th>åˆ†å­</th><th>åˆ†æ¯</th><th>ç¾å€¼</th><th>å°è¨ˆ</th><th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input class="township" type="text" /></td>
          <td><input class="part" type="text" /></td>
          <td><input class="small" type="text" /></td>
          <td><input class="land-id" type="text" /></td>
          <td><input class="area" type="number" min="0" /></td>
          <td><input class="owner" type="text" /></td>
          <td><input class="numerator" type="number" min="1" /></td>
          <td><input class="denominator" type="number" min="1" /></td>
          <td><input class="value" type="number" min="0" /></td>
          <td class="subtotal">â€”</td>
          <td><button class="btn btn-del">åˆªé™¤</button></td>
        </tr>
      </tbody>
    </table>
    <button id="addPreBtn" class="btn btn-add">ï¼‹ æ–°å¢ï¼ˆåˆ†å‰²å‰ï¼‰</button>

    <!-- åˆ†å‰²å¾Œ -->
    <h2>åˆ†å‰²å¾Œ</h2>
    <table id="postTable">
      <thead>
        <tr>
          <th>é„‰é®å¸‚å€</th><th>æ®µ</th><th>å°æ®µ</th><th>åœ°è™Ÿ</th><th>é¢ç©</th>
          <th>æ‰€æœ‰æ¬Šäºº</th><th>åˆ†å­</th><th>åˆ†æ¯</th><th>ç¾å€¼</th><th>å°è¨ˆ</th><th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input class="township" type="text" /></td>
          <td><input class="part" type="text" /></td>
          <td><input class="small" type="text" /></td>
          <td><input class="land-id" type="text" /></td>
          <td><input class="area" type="number" min="0" /></td>
          <td><input class="owner" type="text" /></td>
          <td><input class="numerator" type="number" min="1" /></td>
          <td><input class="denominator" type="number" min="1" /></td>
          <td><input class="value" type="number" min="0" /></td>
          <td class="subtotal">â€”</td>
          <td><button class="btn btn-del">åˆªé™¤</button></td>
        </tr>
      </tbody>
    </table>
    <button id="addPostBtn" class="btn btn-add">ï¼‹ æ–°å¢ï¼ˆåˆ†å‰²å¾Œï¼‰</button><br><br>

    <button id="calcTaxBtn" class="btn btn-calc">è¨ˆç®—</button>
    <button id="exportExcel" class="btn btn-calc">åŒ¯å‡ºçµæœ Excel</button>
    <!-- <button class="btn btn-calc" id="showStoredBtn">é¡¯ç¤ºå·²å„²å­˜è³‡æ–™</button> -->
    <button class="btn btn-add" onclick="location.href='æ¬Šåˆ©äººè³‡æ–™è¼¸å…¥.html'">
      â¡ï¸ å‰å¾€ç”¢è£½åœŸåœ°ç™»è¨˜ç”³è«‹æ›¸(åªå¯ç”¢ç”Ÿ18äººä»¥ä¸‹æˆ–90ç­†ä»¥ä¸‹è³‡æ–™)
    </button>

    <table id="resultTable">
      <thead>
        <tr>
          <th>æ‰€æœ‰æ¬Šäºº</th><th>åˆ†å‰²å‰ç¸½è¨ˆ</th><th>åˆ†å‰²å¾Œç¸½è¨ˆ</th><th>å·®é¡</th><th>æ˜¯å¦è¶…éæœ€å°ç¾å€¼</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // è¼‰å…¥ header
    fetch('header.html')
      .then(r => r.text())
      .then(html => document.getElementById('header-container').innerHTML = html)
      .catch(e => console.error('è¼‰å…¥ header å¤±æ•—:', e));

    // å¿«é€Ÿå– DOM
    const preTbody   = document.querySelector('#preTable tbody');
    const postTbody  = document.querySelector('#postTable tbody');
    const addPreBtn  = document.getElementById('addPreBtn');
    const addPostBtn = document.getElementById('addPostBtn');
    const calcBtn    = document.getElementById('calcTaxBtn');
    const exportBtn  = document.getElementById('exportExcel');
    const showBtn    = document.getElementById('showStoredBtn');
    const resultTbody= document.querySelector('#resultTable tbody');

    // å»ºç«‹ä¸€åˆ— HTML
    function createRowHTML(){
      return `
        <tr>
          <td><input class="township"  type="text" /></td>
          <td><input class="part"      type="text" /></td>
          <td><input class="small"     type="text" /></td>
          <td><input class="land-id"   type="text" /></td>
          <td><input class="area"      type="number" min="0" /></td>
          <td><input class="owner"     type="text" /></td>
          <td><input class="numerator" type="number" min="1" /></td>
          <td><input class="denominator" type="number" min="1" /></td>
          <td><input class="value"     type="number" min="0" /></td>
          <td class="subtotal">â€”</td>
          <td><button class="btn btn-del">åˆªé™¤</button></td>
        </tr>`;
    }

    // æ–°å¢åˆ—
    addPreBtn.addEventListener('click',  () => preTbody.insertAdjacentHTML('beforeend', createRowHTML()));
    addPostBtn.addEventListener('click', () => postTbody.insertAdjacentHTML('beforeend', createRowHTML()));

    // åˆªé™¤åˆ—
    [preTbody, postTbody].forEach(tbody => {
      tbody.addEventListener('click', e => {
        if (e.target.matches('.btn-del')) e.target.closest('tr').remove();
      });
    });

    // åŒ¯å…¥ Excel
    document.getElementById('importExcel').addEventListener('change', handleFile);
    function handleFile(e){
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const wb = XLSX.read(new Uint8Array(evt.target.result), { type:'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header:1, defval:'' });

        preTbody.innerHTML = '';
        postTbody.innerHTML = '';

        let prevPreTownship='', prevPrePart='', prevPreSmall='';
        let prevPostTownship='', prevPostPart='', prevPostSmall='';

        rows.slice(2).forEach(r => {
          // åˆ†å‰²å‰
          const curPreTown = r[0] !== '' ? r[0] : prevPreTownship;
          const curPrePart = r[1] !== '' ? r[1] : prevPrePart;
          const curPreSmall= r[2] !== '' ? r[2] : prevPreSmall;
          prevPreTownship = curPreTown; prevPrePart = curPrePart; prevPreSmall = curPreSmall;

          if(!isNaN(r[4]) && r[4] !== ''){
            preTbody.insertAdjacentHTML('beforeend', `
              <tr>
                <td><input class="township"  type="text" value="${curPreTown}" /></td>
                <td><input class="part"      type="text" value="${curPrePart}" /></td>
                <td><input class="small"     type="text" value="${curPreSmall}" /></td>
                <td><input class="land-id"   type="text" value="${r[3] || ''}" /></td>
                <td><input class="area"      type="number" value="${r[4] || ''}" /></td>
                <td><input class="owner"     type="text" value="${r[5] || ''}" /></td>
                <td><input class="numerator" type="number" value="${r[6] || ''}" /></td>
                <td><input class="denominator" type="number" value="${r[7] || ''}" /></td>
                <td><input class="value"     type="number" value="${r[8] || ''}" /></td>
                <td class="subtotal">â€”</td>
                <td><button class="btn btn-del">åˆªé™¤</button></td>
              </tr>`);
          }

          // åˆ†å‰²å¾Œ
          const curPostTown = r[10] !== '' ? r[10] : prevPostTownship;
          const curPostPart = r[11] !== '' ? r[11] : prevPostPart;
          const curPostSmall= r[12] !== '' ? r[12] : prevPostSmall;
          prevPostTownship = curPostTown; prevPostPart = curPostPart; prevPostSmall = curPostSmall;

          if(!isNaN(r[14]) && r[14] !== ''){
            postTbody.insertAdjacentHTML('beforeend', `
              <tr>
                <td><input class="township"  type="text" value="${curPostTown}" /></td>
                <td><input class="part"      type="text" value="${curPostPart}" /></td>
                <td><input class="small"     type="text" value="${curPostSmall}" /></td>
                <td><input class="land-id"   type="text" value="${r[13] || ''}" /></td>
                <td><input class="area"      type="number" value="${r[14] || ''}" /></td>
                <td><input class="owner"     type="text" value="${r[15] || ''}" /></td>
                <td><input class="numerator" type="number" value="${r[16] || ''}" /></td>
                <td><input class="denominator" type="number" value="${r[17] || ''}" /></td>
                <td><input class="value"     type="number" value="${r[18] || ''}" /></td>
                <td class="subtotal">â€”</td>
                <td><button class="btn btn-del">åˆªé™¤</button></td>
              </tr>`);
          }
        });
      };
      reader.readAsArrayBuffer(file);
    }

    // è‡ªå‹•è£œå€¼ï¼ˆæŠŠç©ºç™½æ¬„ä½è£œå‰ä¸€åˆ—çš„å€¼ï¼‰
    function fillForward(tbody){
      let lastTown='', lastPart='', lastSmall='', lastId='';
      tbody.querySelectorAll('tr').forEach(row => {
        const town = row.querySelector('.township');
        const part = row.querySelector('.part');
        const small= row.querySelector('.small');
        const lid  = row.querySelector('.land-id');
        if(town.value.trim()  !== '') lastTown  = town.value.trim();  else town.value  = lastTown;
        if(part.value.trim()  !== '') lastPart  = part.value.trim();  else part.value  = lastPart;
        if(small.value.trim() !== '') lastSmall = small.value.trim(); else small.value = lastSmall;
        if(lid.value.trim()   !== '') lastId    = lid.value.trim();   else lid.value   = lastId;
      });
    }

    // è¨ˆç®—å°è¨ˆï¼†å½™ç¸½
    function tallyByOwner(tbody){
      const map = {};
      tbody.querySelectorAll('tr').forEach(row => {
        const a = parseFloat(row.querySelector('.area').value);
        const n = parseFloat(row.querySelector('.numerator').value);
        const d = parseFloat(row.querySelector('.denominator').value);
        const v = parseFloat(row.querySelector('.value').value);
        const owner = row.querySelector('.owner').value.trim() || 'æœªå¡«';
        if (!isNaN(a) && !isNaN(n) && d > 0 && !isNaN(v)) {
          const sub = a * n / d * v;
          map[owner] = (map[owner] || 0) + sub;
          row.querySelector('.subtotal').textContent = sub.toFixed(2);
        } else {
          row.querySelector('.subtotal').textContent = 'â€”';
        }
      });
      return map;
    }

    // å„²å­˜ï¼šåŒ…å«ç¾å€¼ v èˆ‡å°è¨ˆ i
    function saveLandDetails(){
      const extract = (tbody) => {
        const rows = [];
        tbody.querySelectorAll('tr').forEach(row => {
          const a = row.querySelector('.township')?.value || '';
          const b = row.querySelector('.part')?.value || '';
          const c = row.querySelector('.small')?.value || '';
          const d = row.querySelector('.land-id')?.value || '';
          const e = parseFloat(row.querySelector('.area')?.value) || 0;
          const f = row.querySelector('.owner')?.value || '';
          const g = parseInt(row.querySelector('.numerator')?.value) || 1;
          const h = parseInt(row.querySelector('.denominator')?.value) || 1;
          const v = parseFloat(row.querySelector('.value')?.value);
          const iText = row.querySelector('.subtotal')?.textContent || '';
          const i = Number.isFinite(parseFloat(iText)) ? parseFloat(iText) : 0;
          rows.push({ a,b,c,d,e,f,g,h, v: Number.isFinite(v) ? v : 0, i });
        });
        return rows;
      };
      localStorage.setItem('landDetails', JSON.stringify({
        pre:  extract(preTbody),
        post: extract(postTbody)
      }));
    }

    // å¾å„²å­˜é‚„åŸ
    function restoreTablesFromStorage(){
      const raw = localStorage.getItem('landDetails');
      if (!raw) return;
      const parsed = JSON.parse(raw);
      const toRowHTML = r => `
        <tr>
          <td><input class="township"  type="text" value="${r.a || ''}"/></td>
          <td><input class="part"      type="text" value="${r.b || ''}"/></td>
          <td><input class="small"     type="text" value="${r.c || ''}"/></td>
          <td><input class="land-id"   type="text" value="${r.d || ''}"/></td>
          <td><input class="area"      type="number" value="${r.e ?? ''}"/></td>
          <td><input class="owner"     type="text" value="${r.f || ''}"/></td>
          <td><input class="numerator" type="number" value="${r.g ?? ''}"/></td>
          <td><input class="denominator" type="number" value="${r.h ?? ''}"/></td>
          <td><input class="value"     type="number" value="${r.v ?? ''}"/></td>
          <td class="subtotal">â€”</td>
          <td><button class="btn btn-del">åˆªé™¤</button></td>
        </tr>`;
      if (Array.isArray(parsed.pre)  && parsed.pre.length)  preTbody.innerHTML  = parsed.pre.map(toRowHTML).join('');
      if (Array.isArray(parsed.post) && parsed.post.length) postTbody.innerHTML = parsed.post.map(toRowHTML).join('');
    }

    // è¨ˆç®—æŒ‰éˆ•
    calcBtn.addEventListener('click', () => {
      fillForward(preTbody);
      fillForward(postTbody);

      const preMap  = tallyByOwner(preTbody);
      const postMap = tallyByOwner(postTbody);

      // å–å¾—æ‰€æœ‰ç¾å€¼çš„æœ€å°å€¼
      const allVals = [...preTbody.querySelectorAll('.value'), ...postTbody.querySelectorAll('.value')]
        .map(i => parseFloat(i.value)).filter(v => !isNaN(v));
      const minVal = allVals.length ? Math.min(...allVals) : 0;

      // é¡¯ç¤ºçµæœ
      resultTbody.innerHTML = '';
      const owners = new Set([...Object.keys(preMap), ...Object.keys(postMap)]);
      owners.forEach(owner => {
        const preSum  = preMap[owner]  || 0;
        const postSum = postMap[owner] || 0;
        const diff    = postSum - preSum;
        const flag    = Math.abs(diff) > minVal ? 'æ˜¯' : 'å¦';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${owner}</td>
          <td>${preSum.toFixed(2)}</td>
          <td>${postSum.toFixed(2)}</td>
          <td>${diff.toFixed(2)}</td>
          <td>${flag}</td>`;
        resultTbody.appendChild(tr);
      });

      // å­˜æª”ï¼ˆå«å°è¨ˆï¼‰
      saveLandDetails();
      console.log('âœ… å·²å„²å­˜ landDetails è‡³ localStorageï¼');
    });

    // åŒ¯å‡º Excel
    exportBtn.addEventListener('click', () => {
      calcBtn.click(); // å…ˆé‡æ–°è¨ˆç®—ï¼†å­˜æª”
      const ws = XLSX.utils.table_to_sheet(document.getElementById('resultTable'));
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'è¨ˆç®—çµæœ');
      XLSX.writeFile(wb, 'åœŸåœ°åˆ†å‰²è¨ˆç®—çµæœ.xlsx');
    });

    // é¡¯ç¤ºå·²å„²å­˜è³‡æ–™
    showBtn.addEventListener('click', () => {
      const data = localStorage.getItem('landDetails');
      if (data) {
        const parsed = JSON.parse(data);
        console.log('ã€åˆ†å‰²å‰è³‡æ–™ã€‘ï¼š', parsed.pre);
        console.log('ã€åˆ†å‰²å¾Œè³‡æ–™ã€‘ï¼š', parsed.post);
        alert('å·²å„²å­˜è³‡æ–™ï¼Œè«‹é–‹å•Ÿ F12 â†’ Console æŸ¥çœ‹è©³ç´°å…§å®¹');
      } else {
        alert('å°šæœªå„²å­˜ä»»ä½•è³‡æ–™ï¼');
      }
    });

    // ä¾ URL åƒæ•¸ mode é‚„åŸ/é‡ç½®
    (function handleMode(){
      const mode = new URLSearchParams(location.search).get('mode');
      if (mode === 'reset') {
        localStorage.removeItem('landDetails');
        preTbody.innerHTML  = createRowHTML();
        postTbody.innerHTML = createRowHTML();
      } else if (mode === 'edit') {
        restoreTablesFromStorage();
      }
    })();

  }); // DOMContentLoaded
  </script>
</body>
</html>
