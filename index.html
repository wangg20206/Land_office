<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>åˆ†å‰²å‰å¾ŒåœŸåœ°åœ°ç¨…è¨ˆç®—</title>
  <!-- SheetJS ç”¨ä¾†è®€å¯« Excel -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 24px;
      background: #f5f5f5;
    }
    h1{
      text-align: center;
    }
    h2 {
      margin-top: 32px;
      color: #333;
    
    }
    h3{
      margin-top: 32px;
      color: #e20505;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 16px;
      background: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      text-align: center;
    }
    th {
      background: #e0e0e0;
    }
    input[type="number"],
    input[type="text"] {
      width: 90%;
      padding: 4px;
      box-sizing: border-box;
    }
    .btn {
      padding: 6px 12px;
      margin: 4px;
      border: none;
      color: #fff;
      cursor: pointer;
      border-radius: 4px;
    }
    .btn-add   { background: #4caf50; }
    .btn-calc  { background: #2196f3; }
    .btn-del   { background: #f44336; }
    #calcTaxBtn { background: #ff9800; }
  </style>
</head>
<body>
  <h1>å…±æœ‰ç‰©åˆ†å‰²å‰å¾Œå·®é¡è¨ˆç®—</h1>
  <h3>è«‹ç¢ºèªè¼¸å…¥è³‡æ–™èˆ‡å…±æœ‰ç‰©åˆ†å‰²å”è­°æ›¸ç›¸ç¬¦</h3>
  <h3>æœ¬è¡¨è¨ˆç®—çµæœåƒ…ä¾›åƒè€ƒ</h3>
  <h3>å¦‚è¦ä½¿ç”¨åŒ¯å…¥æª”æ¡ˆï¼Œè«‹ä½¿ç”¨æœ¬ç¶²é æä¾›ä¹‹è¨ˆç®—è¡¨æ ¼</h3>
  <!-- æ”¾åœ¨åŒ¯å…¥æª”æ¡ˆ input ä¹‹å‰ -->
<a href="./å…±æœ‰ç‰©åˆ†å‰²å‰å¾Œå·®é¡è¨ˆç®—è¡¨æ ¼.xlsx"
   download="åˆ†å‰²å‰å¾ŒåœŸåœ°åˆ†å‰²ç¯„ä¾‹.xlsx"
   class="btn btn-add">
  ğŸ“¥ ä¸‹è¼‰ Excel ç¯„ä¾‹
</a>
<input type="file" id="importExcel" accept=".xlsx,.xls" />



  <h2>åˆ†å‰²å‰</h2>
  <table id="preTable">
    <thead>
      <tr>
        <th>åœ°è™Ÿ</th><th>é¢ç©</th><th>æ‰€æœ‰æ¬Šäºº</th>
        <th>åˆ†å­</th><th>åˆ†æ¯</th><th>ç¾å€¼</th>
        <th>å°è¨ˆ</th><th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input class="land-id" type="text" /></td>
        <td><input class="area" type="number" min="0" /></td>
        <td><input class="owner" type="text" /></td>
        <td><input class="numerator" type="number" min="1" /></td>
        <td><input class="denominator" type="number" min="1" /></td>
        <td><input class="value" type="number" min="0" /></td>
        <td class="subtotal">â€”</td>
        <td><button class="btn btn-del">åˆªé™¤</button></td>
      </tr>
    </tbody>
  </table>
  <button id="addPreBtn" class="btn btn-add">ï¼‹ æ–°å¢ï¼ˆåˆ†å‰²å‰ï¼‰</button>

  <h2>åˆ†å‰²å¾Œ</h2>
  <table id="postTable">
    <thead>
      <tr>
        <th>åœ°è™Ÿ</th><th>é¢ç©</th><th>æ‰€æœ‰æ¬Šäºº</th>
        <th>åˆ†å­</th><th>åˆ†æ¯</th><th>ç¾å€¼</th>
        <th>å°è¨ˆ</th><th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input class="land-id" type="text" /></td>
        <td><input class="area" type="number" min="0" /></td>
        <td><input class="owner" type="text" /></td>
        <td><input class="numerator" type="number" min="1" /></td>
        <td><input class="denominator" type="number" min="1" /></td>
        <td><input class="value" type="number" min="0" /></td>
        <td class="subtotal">â€”</td>
        <td><button class="btn btn-del">åˆªé™¤</button></td>
      </tr>
    </tbody>
  </table>
  <button id="addPostBtn" class="btn btn-add">ï¼‹ æ–°å¢ï¼ˆåˆ†å‰²å¾Œï¼‰</button><br>
  <br>
  <button id="calcTaxBtn" class="btn btn-calc">è¨ˆç®—</button><!-- æ”¾åœ¨è¨ˆç®—æŒ‰éˆ•ä¸Šä¸‹ -->

  <button id="exportExcel" class="btn btn-calc">åŒ¯å‡ºçµæœ Excel</button>



  <table id="resultTable">
    <thead>
      <tr>
        <th>æ‰€æœ‰æ¬Šäºº</th>
        <th>åˆ†å‰²å‰ç¸½è¨ˆ</th>
        <th>åˆ†å‰²å¾Œç¸½è¨ˆ</th>
        <th>å·®é¡</th>
        <th>æ˜¯å¦è¶…é1å¹³æ–¹å…¬å°º</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const preTbody    = document.querySelector('#preTable tbody');
    const postTbody   = document.querySelector('#postTable tbody');
    const addPreBtn   = document.getElementById('addPreBtn');
    const addPostBtn  = document.getElementById('addPostBtn');
    const calcTaxBtn  = document.getElementById('calcTaxBtn');
    const resultTbody = document.querySelector('#resultTable tbody');

    function createRowHTML() {
      return `
      <tr>
        <td><input class="land-id" type="text" /></td>
        <td><input class="area" type="number" min="0" /></td>
        <td><input class="owner" type="text" /></td>
        <td><input class="numerator" type="number" min="1" /></td>
        <td><input class="denominator" type="number" min="1" /></td>
        <td><input class="value" type="number" min="0" /></td>
        <td class="subtotal">â€”</td>
        <td><button class="btn btn-del">åˆªé™¤</button></td>
      </tr>`;
    }

    addPreBtn.addEventListener('click', () =>
      preTbody.insertAdjacentHTML('beforeend', createRowHTML())
    );
    addPostBtn.addEventListener('click', () =>
      postTbody.insertAdjacentHTML('beforeend', createRowHTML())
    );

    [preTbody, postTbody].forEach(tbody => {
      tbody.addEventListener('click', e => {
        if (e.target.matches('.btn-del'))
          e.target.closest('tr').remove();
      });
    });


    document.getElementById('importExcel').addEventListener('change', handleFile, false);

function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    const data = new Uint8Array(evt.target.result);
    const wb   = XLSX.read(data, { type: 'array' });
    const ws   = wb.Sheets[wb.SheetNames[0]];
    // è®€æˆäºŒç¶­é™£åˆ—ï¼Œdefval:'' å¯ä¿è­‰ç©ºç™½ä¸æœƒæˆ undefined
    const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
    // æ¸…ç©ºåŸæœ¬çš„è¡¨æ ¼
    preTbody.innerHTML  = '';
    postTbody.innerHTML = '';

    // å¾ index=2 é–‹å§‹æ‰æ˜¯è³‡æ–™åˆ—ï¼ˆè·³éå‰å…©åˆ—æ¨™é¡Œï¼‰
    rows.slice(2).forEach(r => {
      // Aâ€“G (0â€“6)  æ˜¯ã€Œåˆ†å‰²å‰ã€æ¬„ä½
      const preLand   = r[0], preArea   = r[1], preOwner   = r[2];
      const preNum    = r[3], preDen    = r[4], preValue   = r[5];
      // Iâ€“O (8â€“14) æ˜¯ã€Œåˆ†å‰²å¾Œã€æ¬„ä½
      const postLand  = r[8], postArea  = r[9], postOwner  = r[10];
      const postNum   = r[11], postDen   = r[12], postValue  = r[13];

      // åˆ¤æ–·è¦æ”¾å“ªå¼µè¡¨ï¼šå¦‚æœ A æ¬„æˆ– B æ¬„æœ‰æ•¸å€¼ï¼Œå°±ç•¶ preï¼›å¦‚æœ I æ¬„æˆ– J æ¬„æœ‰æ•¸å€¼ï¼Œå°±ç•¶ post
      if ((preLand || preArea) && !isNaN(parseFloat(preArea))) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input class="land-id"    type="text"   value="${preLand}"  /></td>
          <td><input class="area"       type="number" value="${preArea}" /></td>
          <td><input class="owner"      type="text"   value="${preOwner}" /></td>
          <td><input class="numerator"  type="number" value="${preNum}"   /></td>
          <td><input class="denominator"type="number" value="${preDen}"   /></td>
          <td><input class="value"      type="number" value="${preValue}" /></td>
          <td class="subtotal">â€”</td>
          <td><button class="btn btn-del">åˆªé™¤</button></td>`;
        preTbody.appendChild(tr);
      }

      if ((postLand || postArea) && !isNaN(parseFloat(postArea))) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input class="land-id"    type="text"   value="${postLand}"  /></td>
          <td><input class="area"       type="number" value="${postArea}" /></td>
          <td><input class="owner"      type="text"   value="${postOwner}" /></td>
          <td><input class="numerator"  type="number" value="${postNum}"   /></td>
          <td><input class="denominator"type="number" value="${postDen}"   /></td>
          <td><input class="value"      type="number" value="${postValue}" /></td>
          <td class="subtotal">â€”</td>
          <td><button class="btn btn-del">åˆªé™¤</button></td>`;
        postTbody.appendChild(tr);
      }
    });
  };
  reader.readAsArrayBuffer(file);
}

// ç¶å®š input[type=file]
document.getElementById('importExcel')
        .addEventListener('change', handleFile, false);




    function tallyByOwner(tbody) {
      const map = {};
      tbody.querySelectorAll('tr').forEach(row => {
        const a     = parseFloat(row.querySelector('.area').value);
        const n     = parseFloat(row.querySelector('.numerator').value);
        const d     = parseFloat(row.querySelector('.denominator').value);
        const v     = parseFloat(row.querySelector('.value').value);
        const owner = row.querySelector('.owner').value.trim() || 'æœªå¡«';

        if (!isNaN(a) && !isNaN(n) && d > 0 && !isNaN(v)) {
          const sub = a * n / d * v;
          map[owner] = (map[owner] || 0) + sub;
          row.querySelector('.subtotal').textContent = sub.toFixed(2);
        } else {
          row.querySelector('.subtotal').textContent = 'â€”';
        }
      });
      return map;
    }

    calcTaxBtn.addEventListener('click', () => {
      const allVals = [
        ...preTbody.querySelectorAll('.value'),
        ...postTbody.querySelectorAll('.value')
      ].map(inp => parseFloat(inp.value))
       .filter(v => !isNaN(v));
      const minVal = allVals.length ? Math.min(...allVals) : 0;


      const preMap  = tallyByOwner(preTbody);
      const postMap = tallyByOwner(postTbody);


      const owners = new Set([...Object.keys(preMap), ...Object.keys(postMap)]);
      resultTbody.innerHTML = '';

      owners.forEach(owner => {
        const preSum  = preMap[owner]  || 0;
        const postSum = postMap[owner] || 0;
        const diff    = postSum - preSum;
        const check   = minVal - diff;
        const flag    = check > 1 ? 'å¦' : 'æ˜¯';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${owner}</td>
          <td>${preSum.toFixed(2)}</td>
          <td>${postSum.toFixed(2)}</td>
          <td>${diff.toFixed(2)}</td>
          <td>${flag}</td>
        `;
        resultTbody.appendChild(tr);
      });
    });

    document.getElementById('exportExcel').addEventListener('click', () => {
  // å…ˆè§¸ç™¼è¨ˆç®—ï¼Œç¢ºä¿ resultTable å·²å¡«å…¥æœ€æ–°è³‡æ–™
  calcTaxBtn.click();

  // è®€å–çµæœ table
  const table = document.getElementById('resultTable');
  const ws    = XLSX.utils.table_to_sheet(table);
  const wb    = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'è¨ˆç®—çµæœ');

  // ç”¢ç”Ÿæª”æ¡ˆä¸¦ä¸‹è¼‰
  XLSX.writeFile(wb, 'åœŸåœ°åˆ†å‰²è¨ˆç®—çµæœ.xlsx');
});


  </script>
</body>
</html>
